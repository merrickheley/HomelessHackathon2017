{% extends "HackApp/base.html" %}
{% load staticfiles %}

{% block head %}
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-CI0xR7pu20lYiwVzu5D3A3FxTrp7gKg"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'icons/css/map-icons.css' %}">
    <script type="application/javascript" src="{% static 'js/map-icons.js' %}"></script>
    <script>
        var map;
        var lat;
        var lon;

        function get(name) {
            if (name = (new RegExp('[?&]' + encodeURIComponent(name) + '=([^&]*)')).exec(location.search))
                return decodeURIComponent(name[1]);
        }

        function calculateAndDisplayRoute(directionsService, directionsDisplay, pointA, pointB) {
          directionsService.route({
            origin: pointA,
            destination: pointB,
            travelMode: google.maps.TravelMode.DRIVING
          }, function(response, status) {
            if (status == google.maps.DirectionsStatus.OK) {
              directionsDisplay.setDirections(response);
            } else {
              window.alert('Directions request failed due to ' + status);
            }
          });
        }

        var icons = {
            location: {
               icon: {
                    path: MAP_PIN,
                    fillColor: 'red',
                    fillOpacity: 1,
                    strokeColor: '',
                    strokeWeight: 0
                },
                map_icon_label: '<span class="map-icon map-icon-unisex"></span>'
            },
            home: {
                icon: {
                    path: SQUARE_PIN,
                    fillColor: '#FFCD00',
                    fillOpacity: 1,
                    strokeColor: '',
                    strokeWeight: 0
                },
                map_icon_label: '<span class="map-icon map-icon-real-estate-agency"></span>'
            },
            provider: {
                icon: {
                    path: SHIELD,
                    fillColor: '#00CCBB',
                    fillOpacity: 1,
                    strokeColor: '',
                    strokeWeight: 0
                },
                map_icon_label: '<span class="map-icon map-icon-place-of-worship"></span>'
            }
        };

        function initMap() {
            lat = parseFloat(get('lat'));
            lon = parseFloat(get('lon'));

            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: lat, lng: lon},
                zoom: 14
            });

            // Instantiate a directions service.
            directionsService = new google.maps.DirectionsService;
            directionsDisplay = new google.maps.DirectionsRenderer({
                map: map,
                options: {
                    suppressMarkers: true,
                }
            });


            var userPos = new google.maps.LatLng(lat, lon);

            var features = [
                    {
                        position: userPos,
                        type: 'location',
                    },
                {% for house in houses %}
                    {
                        position: new google.maps.LatLng({{ house.lon }}, {{ house.lat }}),
                        type: 'home',
                        infowindowtext: "{{ house.address }}",
                    },
                {% endfor %}
                {% for provider in providers %}
                    {
                        position: new google.maps.LatLng({{ provider.lat }}, {{ provider.lon }}),
                        type: 'provider',
                        infowindowtext: "{{ provider.name }}",
                    },
                {% endfor %}
            ];

            // Create markers.
            features.forEach(function(feature) {
                var marker = new Marker({
                    map: map,
                    position: feature.position,
                    icon: icons[feature.type].icon,
                    map_icon_label: icons[feature.type].map_icon_label,
                    infowindowtext: feature.infowindowtext,
                });

                if (typeof(feature.infowindowtext) !== 'undefined') {
                    var infowindow = new google.maps.InfoWindow({
                        content: feature.infowindowtext,
                    });

                    marker.addListener('click', function () {
                        infowindow.open(map, marker);
                    });
                }
            });

            calculateAndDisplayRoute(directionsService, directionsDisplay,
                userPos,
                features[1].position
            );
        }

        google.maps.event.addDomListener(window, 'load', initMap);
    </script>
{% endblock %}

{% block content %}
    <div class="body-content">
        <h1>Search Results</h1>
        <div class="row">
            <div class="col-lg-7">
                <!-- http://getbootstrap.com/css/#tables -->
                <table class="table table-striped table-hover">
                    <tbody>
                    {% for house in houses %}
                        <tr>
                            <td>{{ house.address }}</td>
                            <td>{{ house.post_code }}</td>
                            <td>{{ house.score }}</td>
                            {% for provider in house.providers %}
                                <td><span class="badge"><span class="lnr {{ provider.icon }}"></span> {{ provider.name }}</span></td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="col-lg-5">
                <div id="map"></div>
            </div>
        </div>
    </div>
{% endblock %}